<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª Teste Twilio - DiagnÃ³stico</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: #000; }
        .btn-danger { background: #dc3545; }
        
        .log-area {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        .status-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        .status-success { border-left: 4px solid #28a745; }
        .status-error { border-left: 4px solid #dc3545; }
        .status-warning { border-left: 4px solid #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª DiagnÃ³stico Twilio</h1>
        <p>Vamos verificar se o Twilio estÃ¡ configurado corretamente no seu sistema.</p>

        <div class="status-card" id="config-status">
            <h3>âš™ï¸ Status da ConfiguraÃ§Ã£o</h3>
            <div id="config-result">Clique em "Verificar ConfiguraÃ§Ã£o" para testar</div>
        </div>

        <div>
            <button class="btn btn-success" onclick="checkTwilioConfig()">âš™ï¸ Verificar ConfiguraÃ§Ã£o</button>
            <button class="btn" onclick="testTwilioStatus()">ğŸ“Š Testar Status Twilio</button>
            <button class="btn btn-warning" onclick="testWhatsAppStatus()">ğŸ“± Status WhatsApp Geral</button>
            <button class="btn btn-danger" onclick="clearLogs()">ğŸ—‘ï¸ Limpar Logs</button>
        </div>

        <div class="log-area" id="log-area">
            <div>ğŸ§ª DiagnÃ³stico Twilio iniciado</div>
            <div>ğŸ“‹ Clique nos botÃµes acima para testar</div>
        </div>

        <div class="status-card status-warning">
            <h3>ğŸ”§ PossÃ­veis Problemas:</h3>
            <ul>
                <li><strong>Sandbox nÃ£o ativado:</strong> Precisa ativar WhatsApp Sandbox no Twilio</li>
                <li><strong>NÃºmero nÃ£o verificado:</strong> Seu nÃºmero precisa estar na lista de teste</li>
                <li><strong>Credenciais erradas:</strong> Account SID ou Auth Token incorretos</li>
                <li><strong>Deploy nÃ£o terminou:</strong> Aguarde o Vercel terminar o deploy</li>
            </ul>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const container = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString();
            
            const colors = {
                info: '#00ff00',
                success: '#00ff88',
                warning: '#ffff00',
                error: '#ff0000'
            };

            const div = document.createElement('div');
            div.style.color = colors[type] || colors.info;
            div.textContent = `[${timestamp}] ${message}`;
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function checkTwilioConfig() {
            log('ğŸ” Verificando configuraÃ§Ã£o Twilio...', 'info');
            
            try {
                const response = await fetch('/api/whatsapp/status');
                const data = await response.json();
                
                log('ğŸ“Š Status recebido da API', 'success');
                
                if (data.providers?.twilio?.configured) {
                    log('âœ… Twilio estÃ¡ configurado!', 'success');
                    updateConfigStatus('success', 'Twilio Configurado', 'Credenciais encontradas no sistema');
                    
                    // Testar conexÃ£o
                    log('ğŸ§ª Testando conexÃ£o com Twilio...', 'info');
                    await testTwilioConnection();
                } else {
                    log('âŒ Twilio NÃƒO estÃ¡ configurado', 'error');
                    updateConfigStatus('error', 'Twilio NÃ£o Configurado', 'VariÃ¡veis de ambiente nÃ£o encontradas');
                    
                    log('ğŸ’¡ Verifique se as variÃ¡veis foram salvas no Vercel:', 'warning');
                    log('   - TWILIO_ACCOUNT_SID', 'warning');
                    log('   - TWILIO_AUTH_TOKEN', 'warning');
                    log('   - TWILIO_WHATSAPP_FROM', 'warning');
                }
                
            } catch (error) {
                log(`âŒ Erro ao verificar configuraÃ§Ã£o: ${error.message}`, 'error');
                updateConfigStatus('error', 'Erro na VerificaÃ§Ã£o', error.message);
            }
        }

        async function testTwilioConnection() {
            try {
                // Tentar enviar mensagem de teste via Twilio
                const testPayload = {
                    phone: '5582994247688', // Seu nÃºmero
                    message: `ğŸ§ª Teste Twilio - ${new Date().toLocaleString()}`
                };

                log('ğŸ“¤ Enviando mensagem de teste...', 'info');
                
                const response = await fetch('/api/whatsapp/twilio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testPayload)
                });

                const result = await response.json();

                if (result.success) {
                    log('âœ… Teste Twilio SUCESSO!', 'success');
                    log(`ğŸ“¨ Message SID: ${result.data?.messageSid || 'N/A'}`, 'info');
                    updateConfigStatus('success', 'Twilio Funcionando', 'Mensagem de teste enviada com sucesso');
                } else {
                    log(`âŒ Teste Twilio FALHOU: ${result.error}`, 'error');
                    updateConfigStatus('error', 'Twilio com Problema', result.error);
                    
                    // Analisar erro especÃ­fico
                    if (result.error?.includes('21614')) {
                        log('ğŸ”´ ERRO 21614: NÃºmero nÃ£o estÃ¡ no Sandbox', 'error');
                        log('ğŸ’¡ SoluÃ§Ã£o: Adicione seu nÃºmero no Twilio Sandbox', 'warning');
                    } else if (result.error?.includes('20003')) {
                        log('ğŸ”´ ERRO 20003: Credenciais invÃ¡lidas', 'error');
                        log('ğŸ’¡ SoluÃ§Ã£o: Verifique Account SID e Auth Token', 'warning');
                    }
                }

            } catch (error) {
                log(`âŒ Erro na conexÃ£o Twilio: ${error.message}`, 'error');
                updateConfigStatus('error', 'Erro de ConexÃ£o', error.message);
            }
        }

        async function testTwilioStatus() {
            log('ğŸ“Š Testando status especÃ­fico do Twilio...', 'info');
            
            try {
                const response = await fetch('/api/whatsapp/status');
                const data = await response.json();
                
                const twilio = data.providers?.twilio;
                
                if (twilio) {
                    log(`ğŸ“‹ Twilio configurado: ${twilio.configured ? 'SIM' : 'NÃƒO'}`, twilio.configured ? 'success' : 'error');
                    log(`ğŸ“‹ Twilio status: ${twilio.status || 'unknown'}`, 'info');
                } else {
                    log('âŒ Dados do Twilio nÃ£o encontrados na resposta', 'error');
                }
                
            } catch (error) {
                log(`âŒ Erro ao testar status: ${error.message}`, 'error');
            }
        }

        async function testWhatsAppStatus() {
            log('ğŸ“± Verificando status geral do WhatsApp...', 'info');
            
            try {
                const response = await fetch('/api/whatsapp/status');
                const data = await response.json();
                
                log('ğŸ“Š Status geral:', 'info');
                log(`   Connected: ${data.connected}`, data.connected ? 'success' : 'warning');
                log(`   Message: ${data.message}`, 'info');
                
                if (data.providers) {
                    log('ğŸ“‹ Provedores disponÃ­veis:', 'info');
                    
                    Object.entries(data.providers).forEach(([name, provider]) => {
                        const status = provider.configured ? 'configurado' : 'nÃ£o configurado';
                        const color = provider.configured ? 'success' : 'warning';
                        log(`   ${name}: ${status}`, color);
                    });
                }
                
            } catch (error) {
                log(`âŒ Erro ao verificar status geral: ${error.message}`, 'error');
            }
        }

        function updateConfigStatus(type, title, message) {
            const statusDiv = document.getElementById('config-status');
            const resultDiv = document.getElementById('config-result');
            
            // Remover classes anteriores
            statusDiv.classList.remove('status-success', 'status-error', 'status-warning');
            
            // Adicionar nova classe
            statusDiv.classList.add(`status-${type}`);
            
            resultDiv.innerHTML = `
                <h4>${title}</h4>
                <p>${message}</p>
            `;
        }

        function clearLogs() {
            document.getElementById('log-area').innerHTML = '<div>ğŸ—‘ï¸ Logs limpos - Pronto para novos testes</div>';
        }

        // Auto-inicializar
        window.onload = function() {
            log('ğŸš€ DiagnÃ³stico Twilio carregado', 'success');
            log('ğŸ’¡ Clique em "Verificar ConfiguraÃ§Ã£o" para comeÃ§ar', 'info');
        };
    </script>
</body>
</html>